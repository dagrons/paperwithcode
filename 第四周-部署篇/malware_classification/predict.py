# %%
import torch
from PIL import Image
import numpy as np

from resnet import * 

# %%
# 加载模型字典
model_state_dict_path = "/root/paperwithcode/第三周-训练篇/malware_dpcnn/trained_models/malware_classification%resnet34%best.pt" # 要使用的模型字典地址
model_state_dict = torch.load(model_state_dict_path)
model = ResNet(num_block=[3, 4, 6, 3]).cuda()
model.load_state_dict(model_state_dict)
model.eval()

# %%
def predict(img_path):
    img = Image.open(img_path)
    img = img.resize((64, 64))
    img_mat = np.asarray(img, dtype=np.float32)
    img_mat = np.reshape(img_mat, (1, 64, 64))
    img_mat = np.repeat(img_mat, 3, axis=0)
    img_mat = torch.from_numpy(img_mat)
    img_mat = torch.unsqueeze(img_mat, axis=0).cuda()
    y_pred = model(img_mat)
    prediction = torch.argmax(y_pred, 1)
    return prediction

